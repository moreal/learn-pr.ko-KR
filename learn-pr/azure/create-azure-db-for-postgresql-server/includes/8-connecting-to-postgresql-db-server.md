온-프레미스 PostgreSQL 데이터베이스를 사용한다고 가정해 보겠습니다. 표준 PostgreSQL 서버 수준 방화벽 규칙을 사용하여 모든 보안 측면을 관리하고 서버에 대한 모든 액세스를 잠급니다. 이제는 Azure에서 동일한 서버 수준 방화벽 규칙을 구성하는 방법에 대해 잘 알고 있습니다.

`psql`을 사용하여 만든 이전의 Azure Databases for PostgreSQL 서버 중 하나에 연결할 수 있습니다.

## <a name="allow-azure-service-access"></a>Azure 서비스 액세스 허용

시작하기 전에 PowerShell과 `psql`을 사용하여 서버에 연결하려면 Azure 서비스에 대한 액세스를 허용해야 합니다. 액세스는 두 가지 방법으로 허용할 수 있습니다.

첫 번째 옵션은 **Azure 서비스 방문 허용**을 사용하도록 설정하는 것입니다. 사용자가 만든 사용자 지정 규칙 목록에 규칙이 입력되지 않은 경우에도 액세스를 허용하면 방화벽 규칙이 만들어집니다.

두 번째 옵션은 모든 IP 주소에 대한 액세스를 허용하는 방화벽 규칙을 만드는 것입니다. 규칙에는 `psql`을 실행하는 데 사용하는 PowerShell이 실행되는 클라이언트에 대한 IP 주소가 포함됩니다.

또한 **SSL 연결 적용**은 사용하지 않도록 설정해야 합니다.

시작해 보겠습니다.

[Azure Portal](https://portal.azure.com?azure-portal=true)에 로그인합니다. 방화벽 규칙을 만들려는 서버 리소스로 이동합니다.

**연결 보안** 옵션을 선택하여 오른쪽에 [연결 보안] 블레이드를 엽니다.

![PostgreSQL 데이터베이스 보안 설정](../media-draft/7-db-security-settings.png)

`psql`을 실행하는 PowerShell 클라이언트에 대한 액세스를 허용하려고 합니다.

다음 중 하나를 선택할 수 있습니다.

- **Azure 서비스 방문 허용**을 **켜기**로 설정합니다.
- **SSL 연결 적용**을 **사용 안 함**으로 설정합니다.
- **저장** 단추를 클릭하여 변경 내용을 저장합니다.

또는 모든 IP 주소에 대한 액세스를 허용하는 방화벽 규칙을 추가할 수 있습니다. 다음 값을 사용합니다.

- 규칙 이름: `AllowAll`
- 시작 IP: `0.0.0.0`
- 종료 IP: `255.255.255.255`
- **SSL 연결 적용**을 **사용 안 함**으로 설정합니다.
- **저장** 단추를 클릭하여 변경 내용을 저장합니다.

> [!Warning]
> 이 방화벽 규칙을 만들면 인터넷의 모든 IP 주소에서 서버에 연결하려고 시도할 수 있습니다. 클라이언트에서 사용자 이름과 암호를 사용하여 서버에 액세스 할 수 있는 경우에도 이 규칙을 신중하게 사용하도록 설정하고 보안에 미치는 영향을 이해해야 합니다. 프로덕션 환경에서는 특정 클라이언트 IP 주소에 대한 액세스만 허용할 수 있습니다.

다음 단계에서는 Azure Cloud Shell 세션을 시작합니다. 이 랩에서는 `bash`를 명령줄 환경으로 사용합니다.

- Azure Portal에서 Cloud Shell을 엽니다. [Azure Portal](https://portal.azure.com?azure-portal=true)로 이동하고 [Cloud Shell 열기] 단추를 클릭합니다.

  ![Cloud Shell 단추](../media-draft/cloud-shell-button.png)

- 구독이 여러 개 있는 경우 요청 시 올바른 구독을 사용하고 있는지 확인합니다. 다음 명령을 실행하여 활성 구독을 설정할 수도 있습니다. 0을 사용자의 구독 식별자로 바꿔야 합니다.

   ```bash
   az account set --subscription 00000000-0000-0000-0000-000000000000
   ```

- 다음 명령을 사용하여 psql을 서버에 연결합니다.

  ```bash
  psql --host=<server-name>.postgres.database.azure.com --username=<admin-user>@<server-name> --dbname=postgres
  ```

   `server-name` 및 `admin-user`는 서버를 만들 때 관리자 계정에 대해 선택한 값입니다. `postgres`는 각 PostgreSQL 서버를 만들 때마다 포함되는 기본 관리 데이터베이스입니다. 서버를 만들 때 제공한 암호를 묻는 메시지가 표시됩니다.

- 성공적으로 연결되면 모든 데이터베이스를 나열하는 `\l` 명령을 실행합니다.

   이 명령을 실행하면 둘 이상의 기본 데이터베이스가 반환됩니다.

- 서버에서 psql 작업 실행이 완료되면 `\q` 명령을 실행하여 `psql`을 종료합니다.

- 마지막으로, Cloud Shell을 종료하려면 `exit` 명령을 실행합니다.
