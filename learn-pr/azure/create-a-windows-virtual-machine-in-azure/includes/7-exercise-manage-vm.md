서버가 비디오 데이터를 처리할 준비가 되었습니다. 마지막으로 해야 할 작업은 교통 카메라가 비디오 파일을 서버에 업로드하는 데 사용할 포트를 여는 것입니다. 

## <a name="create-a-network-security-group"></a>네트워크 보안 그룹 만들기

원격 데스크톱 액세스를 원한다고 표시했으므로 Azure에서 자동으로 보안 그룹을 만들었을 것입니다. 하지만 전체 프로세스를 진행할 수 있도록 새 보안 그룹을 만들어 보겠습니다. 이 작업은 VM에 _앞서_ 가상 네트워크를 만들기로 결정한 경우 특히 중요합니다. 앞서 설명한 것처럼, 보안 그룹은 _선택 사항_이며 네트워크를 사용하여 만들 필요는 없습니다.

> [!NOTE]
> 이 VM이 두 번째 VM일 _것이므로_ 이미 해당 네트워크에 적용할 보안 그룹이 있겠지만, 보안 그룹이 없다고 또는 이 VM에 대한 규칙이 다르다고 잠시 가정해보겠습니다.

1. [Azure Portal](https://portal.azure.com?azure-portal=true)의 왼쪽 모서리 세로 막대에서 **리소스 만들기** 단추를 클릭하여 새 리소스 만들기를 시작합니다.

1. 필터 상자에 "네트워크 보안 그룹"을 입력하고 목록에서 일치하는 항목을 선택합니다.

1. **Resource Manager** 배포 모델을 선택했는지 확인하고 **만들기**를 클릭합니다.

1. 보안 그룹의 **이름**을 입력합니다. 마찬가지로 여기서도 명명 규칙이 좋은 방법이므로, "비디오 프로세서 네트워크 보안 그룹 #2 테스트"에 "test-vp-nsg2"를 사용해보겠습니다.

1. 적절한 **구독**을 선택하고 기존 **리소스 그룹**을 사용합니다.

1. 마지막으로, 리소스를 동일한 **위치**에 VM/Virtual Network로 배치합니다. 이 작업이 중요한 것은 이 리소스가 다른 위치에 있는 경우 적용할 수 없기 때문입니다.

1. **만들기**를 클릭하여 그룹을 만듭니다.

## <a name="add-a-new-inbound-rule-to-our-network-security-group"></a>네트워크 보안 그룹에 새 인바운드 규칙 추가

배포를 신속하게 완료해야 합니다.

1. 새 보안 그룹 리소스를 찾아 Azure Portal에서 리소스를 선택합니다.

1. 개요 페이지에서 네트워크를 잠그기 위해 만든 몇 가지 기본 규칙을 발견할 수 있습니다.

    인바운드 측:

    - 한 VNet에서 다른 VNet으로의 모든 인바운드 트래픽이 허용됩니다. 이렇게 하면 VNet의 리소스가 서로 통신할 수 있습니다.
    - Azure Load Balancer "프로브"가 VM이 활성화 상태인지 확인 요청
    - 그 외의 인바운드 트래픽은 거부됩니다.
    아웃바운드 측:
    - VNet에서 모든 네트워크 내 트래픽이 허용됩니다.
    - 인터넷에 대한 모든 아웃바운드 트래픽이 허용됩니다.
    - 그 외의 아웃바운드 트래픽은 거부됩니다.

> [!NOTE]
> 이러한 기본 규칙에는 높은 우선 순위가 설정됩니다. 즉, 기본 규칙은 _마지막_으로 평가됩니다. 기본 규칙을 변경하거나 삭제할 수 없지만 사용자 트래픽을 우선 순위가 낮은 값과 일치하도록 보다 구체적인 규칙을 만들어 기본 규칙을 _재정의_할 수는 있습니다.

1. 보안 그룹에 대한 **설정** 패널에서 **인바운드 보안 규칙** 섹션을 클릭합니다.

1. **+ 추가**를 클릭하여 새 보안 규칙을 추가합니다.

    ![보안 규칙 추가](../media-drafts/8-add-rule.png)

    보안 규칙에 필요한 정보를 입력하는 방법은 기본 및 고급 두 가지 방법이 있습니다. "추가" 패널의 맨 위에 있는 단추를 클릭하여 두 가지 방법 간에 전환할 수 있습니다.

    ![기본 및 고급 규칙 입력](../media-drafts/8-advanced-create-rule.png)

    고급 모드는 규칙을 완전히 사용자 지정할 수 있는 기능을 제공하지만, 알려진 프로토콜을 구성해야 하는 경우 기본 모드가 사용하기에 조금 더 쉽습니다.

1. 기본 모드로 전환합니다.

1. FTP 규칙에 대한 정보를 추가합니다.

    - **서비스**를 FTP로 설정합니다. 이렇게 하면 사용자를 위한 포트 범위를 설정할 수 있습니다.
    - **우선 순위**을 "1000"으로 설정합니다. 이 값은 기본 **거부** 규칙보다 작은 숫자여야 합니다. 모든 값에서 범위를 시작할 수 있지만, 나중에 예외를 만들어야 할 경우를 대비하여 약간의 여유를 두는 것이 좋습니다.
    - 규칙의 이름을 "traffic-cam-ftp-upload-2"로 지정합니다.
    - 규칙의 설명을 입력합니다.

1. **고급** 모드로 다시 전환합니다. 해당 설정이 아직 있는지 확인합니다. 이 패널을 사용하여 더 세분화된 설정을 만들 수 있습니다. 특히 **원본**을 특정 IP 주소 또는 카메라 관련 IP 주소 범위로 제한할 수 있습니다. 로컬 컴퓨터의 현재 IP 주소를 아는 경우에는 시도해 볼 수 있습니다. 그렇지 않은 경우 설정을 "모두"로 두고 규칙을 테스트할 수 있습니다.

1. **추가**를 클릭하여 규칙을 만듭니다. 이렇게 하면 우선 순위에 따라 인바운드 규칙 목록을 업데이트해서 해당 규칙을 검사하게 됩니다.
    
## <a name="apply-the-security-group"></a>보안 그룹 적용

단일 VM을 보호하기 위한 네트워크 인터페이스에 또는 서브넷의 모든 리소스에 적용되는 해당 서브넷에 보안 그룹을 적용할 수 있습니다. 후자 방법이 가장 일반적인 것 같아 해당 작업을 수행하도록 하겠습니다. 가상 네트워크 리소스를 통하거나 간접적으로 가상 네트워크를 사용하는 VM을 통해 Azure에서 이 리소스를 가져올 수 있습니다.

1. 가상 머신에 대한 **개요** 패널로 전환합니다. VM은 **모든 리소스** 아래에 있습니다.

1. **설정** 섹션에서 **네트워킹** 항목을 선택합니다.

    ![VM 설정의 네트워킹 항목](../media-drafts/8-network-settings.png)

1. 네트워킹 속성에서는 **가상 네트워크/서브넷**(리소스로 이동하는 클릭 가능한 링크)을 포함하여 VM에 적용된 네트워킹에 대한 정보를 찾을 수 있습니다. 이 링크를 클릭하여 가상 네트워크를 엽니다. 이 링크는 VM의 **개요** 패널에서 사용할 수_도_ 있습니다. 이러한 링크 중 하나를 클릭하면 가상 네트워크의 **개요**가 열립니다.

1. **설정** 섹션에서 **서브넷** 항목을 선택합니다.

1. 앞에서 VM + 네트워크를 만들었을 때 단일 서브넷(기본값)이 정의되어 있습니다. 목록에서 해당 항목을 클릭하여 세부 정보를 엽니다.

1. **네트워크 보안 그룹** 항목을 클릭합니다.

1. 새 보안 그룹 **test-vp-nsg2**를 선택합니다.

1. **저장**을 클릭하여 변경 내용을 저장합니다. 변경 내용을 네트워크에 적용하려면 1분이 걸립니다.

## <a name="verify-the-rules"></a>규칙 확인

변경 내용의 유효성을 검사해 보겠습니다.

1. 가상 머신의 **개요** 패널로 다시 전환합니다. VM은 **모든 리소스** 아래에 있습니다.

1. **설정** 섹션에서 **네트워킹** 항목을 선택합니다.

1. 네트워크에 대한 **개요** 패널에는 신속하게 규칙을 평가하는 방법을 보여주는 **효과적인 보안 규칙에 대한 링크가 있습니다. 링크를 클릭하여 분석을 열고 FTP 규칙이 표시되는지 확인합니다.

    ![네트워크에 대한 효과적인 보안 규칙](../media-drafts/8-effective-rules.png)

1. FTP 서버 역할을 설치한 경우 이제 FTP 엔드포인트에 연결할 수 있을 것입니다. 직접 시도해 보세요.

## <a name="one-more-thing"></a>추가 사항

보안 규칙을 올바르게 이해하기는 쉽지 않습니다. 실제로 우리는 이 새 보안 그룹을 적용할 때 실수를 하는 바람에 원격 데스크톱 액세스가 손실되었습니다. 이 문제를 해결하려면 보안 그룹에 다른 규칙을 추가하여 RDP 액세스를 지원할 수 있습니다. 규칙에 대한 인바운드 TCP/IP 주소를 소유하는 주소로 제한해야 합니다.

> [!WARNING]
> 관리 액세스에 사용되는 포트는 항상 잠가야 합니다. 더 좋은 방법은 개인 네트워크에 가상 네트워크를 연결하고 해당 주소 범위에서 RDP 또는 SSH 요청만 허용하는 VPN을 만드는 것입니다. 또한 RDP에서 사용하는 포트를 기본 포트인 3389 이외의 포트로 변경할 수 있습니다. 포트 변경으로는 공격을 막는 데 충분하지 않으므로 검색을 조금 더 어렵게 만들어야 합니다.