HA(고가용성)를 통해 아키텍처에서 오류를 처리할 수 있습니다. 여러분이 항상 완전하게 작동해야 하는 시스템을 책임지고 있다고 가정해 봅시다. 오류는 발생할 수 있고 발생할 수 밖에 없습니다. 문제가 생겼을 때 시스템을 온라인 상태로 유지하려면 어떻게 해야 할까요? 서비스 중단 없이 유지 관리를 수행하려면 어떻게 해야 할까요? 

여기서는 고가용성의 필요성을 알아보고, 응용 프로그램 고가용성 요구 사항을 평가하고, Azure 플랫폼으로 가용성 목표를 충족하는 방법을 알아보겠습니다.

## <a name="what-is-high-availability"></a>고가용성이란?

> [!VIDEO https://www.microsoft.com/videoplayer/embed/RE2yEvc]

고가용성 서비스란 종속 서비스 및 하드웨어의 가용성, 로드 및 일시적 오류에 따른 변동을 완화하는 서비스를 말합니다. 응용 프로그램이 정상적으로 수행되면서 온라인 및 사용 가능한 상태로 유지됩니다(또는 그렇게 보이는 상태 유지). 이 가용성은 종종 비즈니스 요구 사항이, 서비스 수준 목표 또는 서비스 수준 계약으로 정의됩니다.

고가용성은 궁극적으로 시스템 구성 요소의 손실이나 심각한 성능 저하를 처리하는 기능입니다. 호스트에 장애가 발생하여 응용 프로그램을 호스트하는 가상 머신이 오프라인 상태가 된 것이 원인일 수 있습니다. 시스템 업그레이드를 위해 계획된 유지 관리 때문일 수 있습니다. 클라우드의 서비스 장애가 원인일 수도 있습니다. 시스템 장애가 발생할 수 있는 위치를 파악하고 장애를 처리할 수 있는 기능을 구축하면 고객에게 제공하는 서비스가 온라인 상태를 유지할 수 있습니다.

일반적으로 서비스 고가용성을 위해서는 서비스를 구성하는 구성 요소의 고가용성이 필요합니다. 제품을 구매하는 온라인 마켓플레이스를 제공하는 웹 사이트를 떠올려 보세요. 고객에게 제공되는 서비스는 온라인으로 제품을 나열, 구매 및 판매하는 기능입니다. 이런 서비스를 제공하려면 데이터베이스, 웹 서버, 응용 프로그램 서버 등을 비롯한 여러 구성 요소가 있어야 합니다. 이러한 구성 요소 각각에 장애가 발생할 수 있으므로 장애의 원인과 위치를 파악하고 아키텍처에서 이러한 장애 지점을 해결하는 방법을 결정해야 합니다.

## <a name="evaluate-high-availability-for-your-architecture"></a>아키텍처에 대한 고가용성 평가

응용 프로그램의 고가용성을 평가하는 단계는 세 단계로 이루어집니다.

1. 응용 프로그램의 서비스 수준 계약 결정
1. 응용 프로그램의 HA 기능 평가
1. 종속된 응용 프로그램의 HA 기능 평가

이 단계를 상세히 살펴보겠습니다.

### <a name="determine-the-service-level-agreement-of-your-application"></a>응용 프로그램의 서비스 수준 계약 확인

SLA(서비스 수준 계약)는 서비스 공급자가 측정 가능한 메트릭과 정의된 책임에 따라 서비스 표준을 확약하는 서비스 공급자와 서비스 소비자 간 계약입니다. SLA는 엄격하거나, 법적 구속력이 있거나, 계약상의 동의이거나, 가용성에 대한 고객의 기대치가 될 수 있습니다. 서비스 메트릭은 일반적으로 서비스 처리량, 용량, 가용성에 중점을 두며 이 모든 것이 다양한 방법으로 측정될 수 있습니다. SLA를 구성하는 특정 메트릭에 관계없이 SLA를 충족시키지 못하면 서비스 공급자 측에 심각한 재정적 파급 효과를 초래할 수 있습니다. 서비스 계약의 공통 구성 요소는 누락된 SLA에 대해 금전적 보상을 보장합니다.

SLO(서비스 수준 목표)는 성능, 안정성 또는 가용성을 측정하는 데 사용되는 대상 메트릭 값입니다. 이러한 메트릭은 요청 처리 성능(밀리초 단위), 서비스 가용성(분/월) 또는 시간당 처리되는 요청 수를 정의하는 메트릭일 수 있습니다. 응용 프로그램에서 노출하는 메트릭을 평가하고 고객이 사용하는 품질 측정 기준을 이해하면 SLO에 허용되는 범위와 허용되지 않는 범위를 정의할 수 있습니다. 이러한 목표를 정의하면 서비스를 지원하는 팀과 서비스를 소비하는 고객의 목표 및 기대치를 명확하게 설정할 수 있습니다. 이러한 SLO는 전체 SLA의 충족 여부를 확인하는 데 사용됩니다.

다음 표는 다양한 SLA 수준의 잠재적인 누적 가동 중지 시간을 보여줍니다. 

| SLA | 주간 가동 중지 시간 | 월간 가동 중지 시간 | 연간 가동 중지 시간 |
| --- | --- | --- | --- |
| 99% |1.68시간 |7.2시간 |3.65일 |
| 99.9% |10.1분 |43.2분 |8.76시간 |
| 99.95% |5분 |21.6분 |4.38시간 |
| 99.99% |1.01분 |4.32분 |52.56분 |
| 99.999% |6초 |25.9초 |5.26분 |

다른 요소가 전부 동일하다면 당연히 가용성이 높을수록 좋습니다. 그러나 9의 수를 늘리려면 그에 따른 비용과 복잡성도 함께 증가합니다. 작동 시간이 99.99%이면 총 월간 가동 중지 시간이 약 5분입니다. 99.999%를 달성하기 위해 추가적인 복잡성과 비용을 감수할 가치가 있습니까? 대답은 비즈니스 요구 사항에 따라 다릅니다. 

다음은 SLA를 정의할 때 고려해야 할 다른 사항입니다.

* 4개의 9(99.99%)를 달성하려면 아마도 수동 개입에 의존한 오류 복구로는 불가능할 것입니다. 응용 프로그램이 자체적으로 진단하고 자체적으로 복구해야 합니다. 
* 9의 수가 4개를 넘어가면 SLA를 충족할 만큼 신속하게 가동 중단을 감지하기가 쉽지 않습니다.
* SLA가 측정되는 시간을 생각해 보세요. 시간이 짧을수록 허용 오차도 작습니다. SLA를 시간별 또는 일별 작동 시간으로 정의할 수가 없습니다. 

아키텍처에 필요한 고가용성 기능을 결정할 때 중요한 첫 번째 단계는 SLA 식별입니다. 이렇게 하면 응용 프로그램의 가용성을 높이는 데 사용할 메서드를 형성하는 데 도움이 됩니다.

### <a name="evaluate-the-ha-capabilities-of-the-application"></a>응용 프로그램의 HA 기능 평가

응용 프로그램의 HA 기능을 평가하려면 오류 분석을 수행합니다. 연결할 수 없거나 구성이 잘못되었거나 예상과 다르게 작동하면 응용 프로그램에 큰 영향을 미칠 수 있는 단일 장애 지점 및 중요한 구성 요소에 중점을 둡니다. 중복성이 있는 영역의 경우, 응용 프로그램이 오류 조건을 감지할 수 있고 자체 복구가 가능한 지 여부를 판단합니다.

부하 분산 장치와 같이 HA 기능을 제공하도록 설계된 부분을 포함하여 응용 프로그램의 모든 구성 요소를 신중하게 평가해야 합니다. 단일 실패 지점은 HA 기능이 통합되도록 수정하거나, HA 기능을 제공할 수 있는 서비스로 교체해야 합니다.

### <a name="evaluate-the-ha-capabilities-of-dependent-applications"></a>종속된 응용 프로그램의 HA 기능 평가

소비자에 대한 응용 프로그램의 SLA 요구 사항뿐 아니라 응용 프로그램이 종속될 수 있는 모든 리소스에 제공된 SLA도 파악해야 합니다. 소비자에게 99.9% 가동 시간을 약속했으나 응용 프로그램이 종속된 서비스의 가동 시간이 99%에 불과하다면 고객에 대한 SLA를 이행하지 못할 위험이 있습니다. 종속 서비스가 SLA를 충분히 제공할 수 없는 경우 자체 SLA를 수정하거나, 종속성을 대안으로 대체하거나, 종속성을 사용할 수 없는 동안 SLA를 충족시킬 방법을 찾아야 합니다. 시나리오와 종속성의 특성에 따라, 캐시 및 작업 큐와 같은 솔루션을 사용하여 실패한 종속성을 일시적으로 해결할 수 있습니다.

## <a name="azures-highly-available-platform"></a>Azure의 고가용성 플랫폼

Azure 클라우드 플랫폼은 모든 서비스에서 고가용성을 제공하도록 설계되었습니다. 다른 시스템과 마찬가지로 응용 프로그램도 하드웨어와 소프트웨어 플랫폼 이벤트의 영향을 받을 수 있습니다. 오류를 처리하도록 응용 프로그램 아키텍처를 설계하는 것이 중요하며, Azure 클라우드 플랫폼은 응용 프로그램의 가용성을 높이는 도구와 기능을 제공합니다. Azure에서 아키텍처에 HA를 고려할 때 핵심적인 몇 가지 개념은 다음과 같습니다.

* 가용성 집합
* 가용성 영역
* 부하 분산
* PaaS(Platform as a Service) 고가용성 기능

### <a name="availability-sets"></a>가용성 집합

가용성 집합은 하드웨어 장애 및 예약된 유지 관리의 영향을 동시에 받지 않도록 방지하기 위해 동일한 응용 프로그램 워크로드에 속하는 VM을 분산시켜야 한다고 Azure에게 알리는 방법입니다. 가용성 집합은 *업데이트 도메인*과 *장애 도메인*으로 구성됩니다.

![세 개의 가용성 집합을 보여주는 일러스트레이션. 첫 번째 집합에는 하나의 업데이트 도메인, 두 번째 집합에는 두 개의 업데이트 도메인이 있고, 세 번째 집합에는 업데이트 도메인이 없습니다.](../media/AzAvailSets.png)

업데이트 도메인은 Azure 데이터 센터에서 호스트되는 가상 머신이 유지 관리를 위해 가동 중지 시간이 필요할 때 응용 프로그램 서버의 하위 집합이 실행 상태를 유지하도록 합니다. 대부분의 업데이트는 실행되는 VM에 영향을 미치지 않고 수행할 수 있지만, 이것이 불가능한 경우도 있습니다. 전체 데이터센터에 한꺼번에 업데이트가 발생하지 않도록 Azure 데이터 센터는 UD(업데이트 도메인)로 논리적으로 구분됩니다. 성능 업데이트 및 중요 보안 패치와 같은 유지 관리 이벤트를 호스트에 적용해야 하는 경우 업데이트 도메인을 통해 업데이트 순서가 지정됩니다. 업데이트 도메인을 통해 업데이트 순서를 지정하면 플랫폼 업데이트와 패치 적용 중에 전체 데이터 센터를 사용할 수 없도록 보장합니다.

업데이트 도메인이 데이터 센터의 논리적 섹션을 나타내는 것과는 달리, FD(장애 도메인)는 데이터센터의 물리적 섹션을 나타내고 가용성 집합에서 서버의 랙 다양성을 보장합니다. 장애 도메인은 데이터센터 내 공유 하드웨어의 물리적 분리와 일치합니다. 여기에는 서버 랙에 있는 물리적 서버를 지원하는 전원, 냉각 장치 및 네트워크 하드웨어가 포함됩니다. 서버 랙을 지원하는 하드웨어를 사용할 수 없게 되면 해당 서버 랙만 가동 중단의 영향을 받습니다. VM을 가용성 집합에 배치하면 VM이 자동으로 여러 FD에 분산되므로 하드웨어 오류가 발생하더라도 VM의 일부만 영향을 받습니다.

가용성 집합을 사용하면 영향이 큰 유지 관리 이벤트가 필요하거나 하드웨어 장애가 발생하는 경우 응용 프로그램을 온라인 상태로 유지할 수 있습니다.

### <a name="availability-zones"></a>가용성 영역

가용성 영역은 자체 전원, 냉각 및 네트워킹을 포함하는 한 지역 내의 독립적인 물리적 데이터센터 위치입니다. 리소스를 배포할 때 가용성 영역을 고려하면 데이터센터 중단으로부터 워크로드를 보호하고 특정 지역에서 서비스 상태를 유지할 수 있습니다. 가상 머신 같은 서비스는 *영역별 서비스*로, 지역 내 특정 영역에 배포할 수 있습니다. 다른 서비스는 *영역 중복 서비스*로, 특정 Azure 지역의 가용성 영역에서 복제됩니다. 두 유형 모두 Azure 지역 내에서 단일 실패 지점이 없도록 합니다.

![Azure 지역 내의 3개 가용성 집합을 보여주는 일러스트레이션. 각 가용성 영역은 고유한 리소스 집합을 갖고 있으며 영역 중복 서비스의 복제를 위해 서로 연결됩니다.](../media/AzAvailZones.png)

지원되는 지역에는 최소 3개 가용성 영역이 포함됩니다. 해당 지역에 영역 서비스 리소스를 만들 때 리소스를 만들 영역을 선택할 수 있습니다. 이렇게 하면 응용 프로그램을 다른 Azure 지역으로 이동하기 전에 영역별 정전을 견뎌내고 Azure 지역에서 계속 작동하도록 응용 프로그램을 설계할 수 있습니다.

가용성 영역은 Azure 지역에 대한 새로운 고가용성 구성 서비스이며, 현재 특정 지역에 제공됩니다. 이 기능을 고려하려는 경우 응용 프로그램을 배포하려는 지역에서 이 서비스의 가용성을 확인하는 것이 중요합니다. 가용성 영역은 가상 머신은 물론 여러 PaaS 서비스를 사용할 때도 지원됩니다. 가용성 영역은 가용성 집합과 함께 사용할 수 없습니다. 가용성 영역을 사용하는 경우 더 이상 시스템의 가용성 집합을 정의할 필요가 없습니다. 데이터 센터 수준에서 다양성이 제공되며, 여러 가용성 영역에서 동시에 업데이트가 수행되지 않습니다.

### <a name="load-balancing"></a>부하 분산

부하 분산 장치는 네트워크 트래픽이 응용 프로그램 전반에 분산되는 방식을 관리합니다. 부하 분산 장치는 개별 구성 요소의 오류에 대한 응용 프로그램의 복원력을 유지하고 응용 프로그램을 사용하여 요청을 처리하도록 보장하는 데 필수적입니다. 서비스 검색을 기본으로 제공하지 않는 응용 프로그램의 경우 가용성 집합과 가용성 영역 모두에 부하 분산이 필요합니다.

Azure에는 네트워크 트래픽을 라우팅하는 기능이 뛰어난 세 가지 부하 분산 기술 서비스가 있습니다.

* **Azure Traffic Manager**는 글로벌 DNS 부하 분산 기술을 제공합니다. Azure 지역 내 또는 전역에서 DNS 엔드포인트의 부하 분산을 제공하는 데 Traffic Manager를 사용하는 것이 좋습니다. Traffic Manager는 사용 가능한 여러 엔드포인트로 요청을 분산하고, 엔드포인트 모니터링을 사용하여 부하에서 실패한 엔드포인트를 검색 및 제거합니다.
* **Azure Application Gateway**는 들어오는 트래픽의 라운드 로빈 배포, 쿠키 기반 세션 선호도, URL 경로 기반 라우팅 및 단일 응용 프로그램 게이트웨이 뒤에 여러 웹 사이트를 호스트하는 기능 등, 레이어 7 부하 분산 기능을 제공합니다. Application Gateway는 기본적으로 백 엔드 풀의 모든 리소스 상태를 모니터링하고 풀에서 비정상으로 간주한 모든 리소스를 자동으로 제거합니다. Application Gateway는 비정상 인스턴스를 계속 모니터링하며 사용할 수 있게 되고 상태 프로브에 응답하게 되면 정상 백 엔드 풀에 다시 추가합니다.
* **Azure Load Balancer**는 레이어 4 부하 분산 장치입니다. 서비스 가용성을 관리하는 TCP 및 HTTP 상태 확인 옵션을 사용하여 공용 및 내부 부하가 분산된 엔드포인트를 구성하고 백 엔드 풀 대상에 인바운드 연결을 매핑하는 규칙을 정의할 수 있습니다.

Azure 부하 분산 기술 중 하나 또는 세 가지의 조합을 통해 응용 프로그램을 통해 네트워크 트래픽을 라우팅하는 고가용성 솔루션을 설계하는 데 필요한 옵션을 사용할 수 있도록 보장합니다.

![Azure 부하 분산 옵션 Azure의 여러 부하 분산 기술을 보여주는 일러스트레이션. Traffic Manager는 두 지역 간의 부하 균형을 조절합니다. 각 지역 내에는 요청 형식에 따라 웹 계층의 여러 가상 머신으로 부하를 분산하는 응용 프로그램 게이트웨이가 있습니다. 모든 이미지 요청은 이미지 서버 풀로 이동하고, 그 외의 요청은 기본 서버 풀에 전달됩니다. 기본 서버 풀에서 들어오는 추가 요청은 Azure 부하 분산 장치를 통해 처리되어 데이터베이스 계층의 가상 머신으로 분산됩니다.](../media/AzLBOptions.png)

### <a name="paas-ha-capabilities"></a>PaaS HA 기능

PaaS 서비스에는 고가용성이 내장되어 있습니다. Azure SQL Database, Azure App Service 및 Azure Service Bus 같은 서비스에는 고가용성 기능이 포함되어 있기 때문에 서비스의 개별 구성 요소에 장애가 발생해도 응용 프로그램이 원활하게 작동합니다. PaaS 서비스를 사용하는 것이 아키텍처의 가용성을 보장하는 최선의 방법 중 하나입니다.

고가용성을 위한 아키텍처를 설계할 때 고객에게 약속하는 SLA를 이해해야 합니다. 그런 다음, 응용 프로그램의 HA 기능과 종속 시스템의 HA 기능 및 SLA를 모두 평가해야 합니다. 이를 정한 후에는 가용성 집합, 가용성 영역 등의 Azure 기능과 다양한 부하 분산 기술을 사용하여 응용 프로그램에 HA 기능을 추가합니다. 사용하도록 선택하는 모든 PaaS 서비스에는 HA 기능이 내장되어 있습니다.
