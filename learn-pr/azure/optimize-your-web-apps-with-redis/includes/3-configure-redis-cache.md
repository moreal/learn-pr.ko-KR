스포츠 통계 개발 팀에서는 캐싱이 최근에 요청된 데이터에 필요한 성능을 크게 향상할 수 있다고 판단했습니다. 그래서 다음 단계로 Azure Redis Cache 인스턴스를 만들고 구성하려고 합니다.

## <a name="create-and-configure-the-azure-redis-cache-instance"></a>Azure Redis Cache 인스턴스 만들기 및 구성

Azure Portal, Azure CLI 또는 Azure PowerShell을 사용하여 Redis Cache를 만들 수 있습니다. 용도에 맞게 캐시를 제대로 구성하기 위해 결정해야 하는 몇 가지 매개 변수가 있습니다.

### <a name="name"></a>이름

Redis Cache에는 전세계에 고유한 이름이 필요합니다. 이름이 서비스와 연결하고 통신하기 위해 공용 URL을 생성하는 데 사용되므로 Azure 내에서 고유해야 합니다.

이름은 1-63자이며 숫자, 영문자 및 '-' 문자로 구성되어야 합니다. 캐시 이름은 '-' 문자로 시작하거나 끝날 수 없으며, 연속되는 '-' 문자는 유효하지 않습니다.

### <a name="resource-group"></a>리소스 그룹

Azure Redis Cache는 관리되는 리소스이며 _리소스 그룹_ 소유자 역할이 필요합니다. 새 리소스 그룹을 만들거나 속한 구독에서 기존 리소스 그룹을 선택할 수 있습니다.

### <a name="location"></a>위치

Azure 지역을 선택하여 Redis Cache를 물리적으로 배치할 위치를 결정해야 합니다. 캐시 인스턴스와 응용 프로그램을 항상 동일한 지역에 배치해야 합니다. 다른 지역의 캐시에 연결하면 대기 시간이 크게 증가하고 안정성이 떨어질 수 있습니다. Azure 외부의 캐시에 연결하는 경우 데이터를 소비하는 응용 프로그램이 실행되는 곳과 가까운 위치를 선택합니다.

> [!IMPORTANT]
> 가능하면 Redis Cache를 _소비자_의 데이터에 가깝게 배치합니다.

### <a name="pricing-tier"></a>가격 책정 계층

마지막 단원에서 언급했듯이 세 가지 가격 책정 계층을 Azure Redis Cache에 사용할 수 있습니다.

- **기본**: 기본 캐시는 개발/테스트에 이상적입니다. 단일 서버, 53GB의 메모리 및 20,000개의 연결로 제한됩니다. 이 서비스 계층에 대한 SLA가 없습니다.
- **표준**: 복제를 지원하고 99.99% SLA를 포함하는 프로덕션 캐시입니다. 두 서버(마스터/슬레이브)를 지원하고, 기본 계층과 동일한 메모리/연결 제한이 있습니다.
- **프리미엄**: 표준 계층에서 빌드하고 지속성, 클러스터링 및 스케일 아웃 캐시 지원이 포함된 Enterprise 계층입니다. 최대 530GB의 메모리 및 40,000개의 동시 연결을 포함한 최고 성능 계층입니다.

각 계층에서 사용 가능한 캐시 메모리 양을 제어할 수 있습니다. 기본/표준에 대해 C0-C6 및 프리미엄에 대해 P0-P4의 캐시 수준을 선택하여 지정합니다. 전체 세부 내용은 [가격 책정 페이지](https://azure.microsoft.com/pricing/details/cache/)를 확인하세요.

> [!TIP]
> 프로덕션 시스템에는 항상 표준 또는 프리미엄 계층을 사용하는 것이 좋습니다. 기본 계층은 데이터 복제 및 SLA가 없는 단일 노드 시스템입니다. 또한 C1 이상의 캐시를 사용합니다. C0 캐시는 공유 CPU 코어를 사용하고 메모리가 매우 적기 때문에 간단한 개발/테스트 시나리오에만 사용하는 것이 좋습니다.

프리미엄 계층을 사용하면 두 가지 방법으로 데이터를 유지하여 재해 복구를 제공할 수 있습니다.

1. RDB 지속성은 주기적 스냅숏을 만들고 실패가 발생하면 해당 스냅숏을 사용하여 캐시를 다시 빌드할 수 있습니다.

    ![새 Redis Cache 인스턴스에 대한 RDB 지속성 옵션을 보여 주는 Azure Portal의 스크린샷입니다.](../media/3-redis-persistence-1.png)

2. AOF 지속성은 초당 한 번 이상 저장되는 로그에 모든 쓰기 작업을 저장합니다. 이렇게 하면 RDB보다 큰 파일이 만들어지지만 데이터 손실은 더 적습니다.

    ![새 Redis Cache 인스턴스에 대한 AOF 지속성 옵션을 보여주는 Azure Portal의 스크린샷](../media/3-redis-persistence-2.png)

**프리미엄** 계층에만 사용할 수 있는 몇 가지 다른 설정이 있습니다.

### <a name="virtual-network-support"></a>Virtual Network 지원

프리미엄 계층 Redis Cache를 만들 경우 클라우드의 가상 네트워크에 배포할 수 있습니다. 캐시는 동일한 가상 네트워크의 다른 가상 머신 및 응용 프로그램에만 사용할 수 있습니다. 서비스와 캐시가 Azure에서 호스트되거나 Azure Virtual Network VPN을 통해 연결된 경우 이 기능은 더 높은 수준의 보안을 제공합니다.

### <a name="clustering-support"></a>클러스터링 지원

프리미엄 계층 Redis Cache를 사용하면 여러 노드에 데이터 집합을 자동으로 분할하도록 클러스터링을 구현할 수 있습니다. 클러스터링을 구현하려면 분할된 데이터베이스 수를 최대 10개까지 지정합니다. 발생하는 비용은 원래 노드에 분할된 데이터베이스 수를 곱한 비용입니다.

## <a name="accessing-the-redis-instance"></a>Redis 인스턴스에 액세스

Redis는 [알려진 명령](https://redis.io/commands) 집합을 지원합니다. 명령은 일반적으로 `COMMAND parameter1 parameter2 parameter3`으로 실행됩니다.

다음은 사용할 수 있는 몇 가지 일반적인 명령입니다.

| 명령 | 설명 |
|---------|-------------|
| `ping` | 서버를 ping 합니다. "PONG"을 반환합니다. |
| `set [key] [value]` | 캐시의 키/값을 설정합니다. 성공 시 "OK"를 반환합니다. |
| `get [key]` | 캐시에서 값을 가져옵니다. |
| `exists [key]` | 캐시에 **키**가 있으면 '1'을 반환하고, 없으면 '0'을 반환합니다. |
| `type [key]` | 특정 **키** 값과 연결된 형식을 반환합니다. |
| `incr [key]` | **키**와 연결된 특정 값을 '1'씩 증가시킵니다. 이 값은 정수이거나 double 값이어야 합니다. 새 값을 반환합니다. |
| `incrby [key] [amount]` | **키**와 연결된 특정 값을 지정된 양만큼 증가시킵니다. 이 값은 정수이거나 double 값이어야 합니다. 새 값을 반환합니다. |
| `del [key]` | **키**와 연결된 값을 삭제합니다. |
| `flushdb` | 데이터베이스의 _모든_ 키와 값을 삭제합니다. |

Redis는 다음 명령을 사용하여 직접 실험에 사용할 수 있는 명령줄 도구(**redis-cli**)를 제공합니다. 다음은 몇 가지 예제입니다.

```output
> set somekey somevalue
OK
> get somekey
"somevalue"
> exists somekey
(string) 1
> del somekey
(string) 1
> exists somekey
(string) 0
```

다음은 `INCR` 명령을 사용하는 예입니다. 캐시를 사용하는 _여러 응용 프로그램에서_ 원자성 증분을 제공하므로 편리합니다.

```output
> set counter 100
OK
> incr counter
(integer) 101
> incrby counter 50
(integer) 151
> type counter
(integer)
```

### <a name="adding-an-expiration-time-to-values"></a>값에 만료 시간 추가

캐싱을 사용하면 일반적으로 사용되는 값을 저장소에 저장할 수 있으므로 캐싱이 중요합니다. 그러나 오래된 값을 만료하는 방법도 필요합니다. Redis에서는 _TTL(Time to live)_ 을 키에 적용하여 오래된 값을 만료합니다.

TTL이 경과되면 마치 DEL 명령을 실행한 것처럼 키가 자동으로 삭제됩니다. 다음은 TTL 만료에 대한 참고 사항입니다.

- 만료 시간은 초 또는 밀리초 단위로 설정할 수 있습니다.
- 만료 시간 해상도는 항상 1밀리초입니다.
- Redis 서버가 중지된 상태로 남아 있으면(즉, Redis가 키의 만료 날짜를 저장하면) 만료에 대한 정보가 복제되어 디스크에 보관되고, 시간이 가상으로 전달됩니다.

다음은 만료의 예입니다.

```output
> set counter 100
OK
> expire counter 5
(integer) 1
> get counter
100
... wait ...
> get counter
(nil)
```

## <a name="accessing-a-redis-cache-from-a-client"></a>클라이언트에서 Redis Cache에 액세스

Azure Redis Cache 인스턴스에 연결하려면 일부 정보가 필요합니다. 클라이언트에는 캐시의 호스트 이름, 포트 및 액세스 키가 필요합니다. 이 정보는 Azure Portal의 **설정 > 액세스 키** 페이지에서 검색할 수 있습니다. 

- 호스트 이름은 캐시 이름을 사용하여 만든 캐시의 공용 인터넷 주소입니다. 예: `sportsresults.redis.cache.windows.net`.

- 액세스 키는 캐시의 암호 역할을 합니다. 두 개의 키가 생성되는데, 하나는 기본 키이고 다른 하나는 보조 키입니다. 둘 중 어느 것이든 사용할 수 있으며, 기본 키를 변경해야 하는 경우에는 둘 다 제공됩니다. 모든 클라이언트를 보조 키로 전환하고, 기본 키를 다시 생성할 수 있습니다. 이렇게 하면 원래 기본 키를 사용하는 응용 프로그램이 차단됩니다. 개인 암호처럼 키를 주기적으로 다시 생성하는 것이 좋습니다.

> [!WARNING]
> 액세스 키는 기밀 정보라고 생각하고 암호처럼 취급해야 합니다. 액세스 키를 갖고 있는 사람은 누구든지 캐시에서 모든 작업을 수행할 수 있습니다!
