온라인 비즈니스를 실행 하는 Azure에 데이터베이스를 게시 하려는 가정해 보겠습니다. 기본적으로 Azure SQL Server 데이터베이스를 Azure 응용 프로그램 또는 Azure 내에서 실행 되는 서비스에 액세스할 수 됩니다. 연결 하는 Azure 내의 서비스에만 허용 하는 경우에 승인 된 응용 프로그램 및 서비스에 데이터베이스에 대 한 연결을 여전히 제한 해야 합니다.

이 장치 IP 주소 범위를 통해 Azure SQL database에 대 한 액세스를 제한 하는 방법을 살펴보겠습니다.

## <a name="overview"></a>개요

새 Azure SQL database는 기본적으로 허용 연결할 Azure 서비스입니다. 이 구성은 연결 서비스는 데이터베이스에 대해 인증을 시도할 수만 해당 데이터베이스 내용에 액세스할 수 있습니다 의미 하지 않습니다. 인증 하도록 서비스를 요구 하는 것이 제한 없는 공용 인터넷 액세스가 보다 안전 합니다. 여전히 응용 프로그램 및 서비스를 필요로 하는 데이터베이스에 액세스를 제한 해야 합니다.

예를 들어, Azure SQL database와 통신 하는 ASP.NET Core 응용 프로그램을 할 수 있습니다. ASP.NET Core 응용 프로그램에는 Azure SQL Server 데이터베이스에 액세스 해야 하는 것입니다. 어떻게 우리는 네트워크 액세스를 제한 하 데이터베이스 웹 응용 프로그램에서 살펴보겠습니다.

## <a name="restricting-network-access-to-the-database"></a>데이터베이스에 대 한 네트워크 액세스 제한

데이터베이스에만 특정 IP 주소 범위에서 액세스를 허용 하 여 네트워크 액세스를 제한 합니다.

![추가 설명된 IP 제한 구성을 사용 하 여 서버 방화벽 규칙 만들기를 보여주는 Azure portal의 스크린샷.](../media-draft/2-setting-ip-address-ranges-on-firewall.png)

1. 서버 방화벽 규칙을 만들려면 입력을 **규칙 이름**의 **시작 IP** 주소 및 **끝 IP** 주소입니다.
1. 누른 **저장** 변경 내용을 기록 합니다.

만든 규칙에 나열 된 IP 주소만 데이터베이스에 액세스를 해야 합니다.

## <a name="locking-down-access-at-the-database-level"></a>데이터베이스 수준에서 액세스를 잠그는

Azure SQL Server 장애 조치 그룹을 실행 하는 경우를 가정해 봅니다. 장애 조치 그룹에 보조 서버는 서로 다른 지역에서 일반적으로 배치 합니다. 주 서버가 오프 라인인 경우 서버 방화벽 규칙 더 이상 적용 될 수 없습니다. 데이터베이스를 호스팅하는 서버 당 서버 방화벽 규칙 설정 됩니다. 데이터베이스 수준 방화벽 규칙을 설정 하면 백업 데이터베이스에 규칙을 복제 합니다.

데이터베이스 방화벽 규칙을 만들려면 SQL Server Management Studio 또는 SQL Operations Studio 사용 하 여 데이터베이스에 연결 하 고 새 쿼리를 만듭니다. 규칙 이름, 시작 ip 및 끝 IP 주소에 전달 하는 다음 규칙을 사용 하 여 데이터베이스 규칙을 만들어야 합니다.

```sql
EXECUTE sp_set_database_firewall_rule N'<Rule Name>', '<From IP Address>', '<To IP Address>'
```

예를 들어, IP 주소 범위 – 10.21.2.33 10.21.2.54의 데이터베이스에 액세스를 제한 하 다음 SQL과 유사한 규칙을 사용할 수 있습니다.

```sql
EXECUTE sp_set_database_firewall_rule N'Web Apps Firewall Rule', '10.21.2.33', '10.21.2.54'
```

## <a name="enabling-transparent-data-encryption-tde"></a>투명 한 데이터 암호화 (TDE)를 사용 하도록 설정

### <a name="what-is-transparent-data-encryption"></a>투명 한 데이터 암호화 란?

Transparent Data Encryption (TDE)는 데이터베이스, 백업 파일 및 로그 파일의 실시간 암호화 및 해독을 수행합니다.

새 Azure SQL 데이터베이스를 만든 경우 TDE 기본적으로 사용 하도록 설정 해야 합니다.

데이터 암호화 되지 않은 해제 되어, 이전 Azure SQL Server 데이터베이스에 TDE를 사용 하도록 없을 확인 하는 것이 반드시 합니다.

확인 하 고 TDE를 사용 하도록 설정 합니다.

1. 포털에서 데이터베이스를 선택 합니다.
1. '투명 한 데이터 암호화' 옵션을 선택 합니다.
1. 데이터 암호화 옵션의 'On'를 선택 합니다.
1. '저장'을 클릭 합니다.

## <a name="create-a-secure-connection-to-the-server"></a>서버에 보안 연결 만들기

응용 프로그램 데이터베이스를 안전 하 게에서 연결 해야 합니다. 보안 연결을 만들려면 적절 한 수준의 보안을 사용 하 여 연결 문자열을 사용 합니다. 이러한 연결은 중간자 개입 공격 가능성을 줄이기 위해 암호화 해야 합니다.

데이터베이스에 대 한 연결 문자열을 가져오는 방법에 살펴보겠습니다.

포털에서 SQL 서버로 이동 합니다. 에 액세스 하려는 데이터베이스를 선택 합니다.

선택 된 *데이터베이스 연결 문자열 표시* 옵션입니다.

이제 사용 가능한 옵션에서 프로그래밍 언어와 일치 하는 탭을 선택 하 고 표시 된 연결 문자열을 복사 합니다. 유지 됩니다 비밀 및 표시 되지 않음 다음으로 암호를 완료 해야 합니다.

![선택한 ADO.NET 및 강조 표시 하 고 제공 된 값 필드를 사용 하 여 데이터베이스 연결 문자열 섹션을 보여 주는 Azure portal의 스크린샷.](../media-draft/2-viewing-connection-strings.png)

연결 문자열 외부로 노출 로부터 보호 하는 것이 반드시 합니다. 연결 문자열은 프로젝트, 버전 제어 또는 연속 통합 시스템에 없는 Azure Key Vault에 저장 되어야 합니다.

### <a name="what-is-the-azure-key-vault"></a>Azure Key Vault 란?

Azure Key Vault는 자격 증명과 기타 키 및 비밀을 안전 하 게 저장 하는 데 사용 하는 도구입니다. 소프트웨어 또는 하드웨어 이러한 암호를 보호할 수 있습니다.

## <a name="open-the-correct-ports-for-server-access"></a>서버 액세스를 위한 올바른 포트 열기

Azure 데이터베이스는 포트 1433 통한 아웃 바운드 통신을 허용합니다. 이 포트에 액세스할 수 없으면 네트워크 트래픽을 허용 하도록 네트워크 관리자에 설명 합니다.

## <a name="restrict-server-access-with-azure-virtual-networks"></a>Azure virtual network 사용 하 여 서버 액세스를 제한 합니다.

### <a name="what-is-a-virtual-network"></a>가상 네트워크란?

가상 네트워크는 Azure 네트워크 내에서 만든 논리적으로 격리 된 네트워크가입니다. 다른 리소스에 연결 하는 Azure 리소스 수를 제어 하는 가상 네트워크를 사용할 수 있습니다.

데이터베이스에 연결 하는 웹 응용 프로그램을 실행 중인 한다고 가정 합니다. 네트워크의 다른 부분을 격리 서브넷을 사용 합니다. 서브넷의 IP 주소 범위에 따라 네트워크의 일부인 합니다.

이러한 서브넷을 구성 하려면 가상 네트워크를 만들고 네트워크 서브넷으로 세분화 합니다. 하나의 서브넷에서 다른 서브넷에 있는 데이터베이스에 웹 응용 프로그램을 작동 합니다. 각 서브넷에 다른 네트워크에서 통신에 대 한 규칙을 직접 해야 합니다. 이러한 규칙 데이터베이스에서 웹 응용 프로그램에 대 한 액세스를 제한 하는 기능을 제공 합니다.

### <a name="what-is-a-network-security-group"></a>네트워크 보안 그룹 이란?

네트워크 보안 그룹에는 원본 및 대상 주소 간의 네트워크 트래픽을 허용 하거나 거부 하는 규칙을 정의 합니다. 각 서브넷에 네트워크 보안 그룹에 할당 해야 합니다.

아래 다이어그램에는 생성 된 그룹화의 예가 나와 있습니다. 웹 서브넷에는 HTTP 연결 대해서만 인터넷에 액세스할 수 있습니다. 데이터베이스 서브넷에만 웹 서브넷에서 액세스할 수 있습니다. 서비스에 액세스할 수 있는 방법과 호스 티 드 서비스 관련 방화벽 역할을 하는 방법에 대 한 제한 추가 virtual network를 설정 합니다.

![연결된 된 데이터베이스를 사용 하 여 웹 응용 프로그램에 대 한 가상 네트워크](../media-draft/2-virtualnetwork-overview.png)

다음 예제에서는 사용자의 웹 호스트 역할을 하며 데이터베이스에 연결 하는 가상 컴퓨터를 사용 하는 것을 가정 합니다. 이 계획 된 인프라를 설정 하는 가상 네트워크를 만드는 방법에 살펴보겠습니다.

1. Azure portal에서 선택 합니다 **리소스 만들기** 링크 합니다.
1. Azure Marketplace에서 선택 **네트워킹** > **가상 네트워크**합니다. 배포 모델 선택을 요청 하는 경우 선택 **Resource Manager**
1. **만들기** 단추를 클릭합니다.
1. 입력 된 **이름을** 가상 네트워크에 대 한 합니다.
1. 제공 된 **주소 공간** 사용할 수 있는 합니다. 주소 공간은 개요의 IP 주소 범위를 표시 하는 방법입니다. 예에서 `172.16.0.0/16` : 172.16.255.255 172.16.0.0에서 주소 범위를 가리킵니다.

   이미 사용 되지 않는 주소 공간 권장 됩니다. 이 범위에서 IP 주소 감지 되 면 여기서이 서브넷에 있는 것으로 정의 됩니다.

1. Azure를 선택 **구독**합니다.
1. 선택 하거나 새로 만듭니다 **리소스 그룹**합니다.
1. 입력 된 **이름을** 만들 서브넷의 합니다.
1. 제공 된 **주소 범위**합니다.
1. 클릭 합니다 **만들기** 단추를 가상 네트워크를 만듭니다.

![에 설명 된 구성을 사용 하 여 가상 네트워크 블레이드 만들기를 보여 주는 Azure portal의 스크린샷](../media-draft/2-create-virtual-network-settings.png)

가상 네트워크 생성 되 면 알림을 받게 됩니다. 클릭 합니다 **리소스로 이동** 알림에서 단추입니다.

이제 가상 네트워크 블레이드로 이동 됩니다. 선택 된 **설정을** > **서브넷** 구성 섹션입니다. 이 시점에서 호출 web_subnet 초기 네트워크를 설정할 때 만든 서브넷을 해야 합니다.

데이터베이스 서버에 대 한 IP 주소를 나타내는 다른 서브넷을 만들려고 합니다.

1. 클릭 합니다 __+ 서브넷__ 데이터베이스에 대 한 새 서브넷을 추가 하는 프로세스를 시작 하는 단추입니다.

1. 입력 한 **이름을** 서브넷에 대 한 합니다. 위의 예제에서는 호출 database_subnet 합니다.

1. 검토 합니다 **주소 범위 (CIDR 블록)** 합니다. 주소 범위를 시스템에서 다른 서브넷 충돌 없는 범위 채워집니다 다시 볼 수 있습니다.

1. **네트워크 보안 그룹** 서브넷에 적용 해야 하는 핵심 설정 합니다. 지금은이 설정은 비워 둡니다. 나중에 있습니다 네트워크 보안 그룹 및 돌아와서 만들고이 값을 설정 합니다.

1. 클릭 합니다 **확인** 서브넷을 저장 하려면 단추입니다.

![에 설명 된 구성 사용 하 여 추가 서브넷 블레이드를 보여 주는 Azure portal의 스크린샷](../media-draft/2-create-database-subnet.png)

## <a name="creating-a-network-security-group"></a>네트워크 보안 그룹 만들기

방화벽으로는 네트워크 보안 그룹의 작업 및 서브넷 내부 및 외부로 트래픽의 흐름을 제어 하 합니다. 두 개의 네트워크 보안 그룹을 만들어야 합니다. 하나는 웹 응용 프로그램 서브넷 하 고 다른 하나는 데이터베이스 서브넷에 대 한 키를 누릅니다.

1. 선택 **리소스 만들기** 선택한 **네트워킹** > **네트워크 보안 그룹**합니다. 배포 모델을 선택 하 라는 메시지가 표시, 리소스 관리자를 선택 합니다.
1. 제공 된 **이름을** 네트워크 보안 그룹에 대 한 합니다.
1. Azure 구독, 리소스 그룹 및 원하는 위치를 선택 합니다.
1. **만들기** 단추를 클릭합니다.

![웹 서브넷에 대해 선택한 웹 보안 그룹을 보여 주는 Azure portal의 스크린샷.](../media-draft/2-define-nsg-for-web-subnet.png)

네트워크 보안 그룹을 만든 후 보안 그룹에 대 한 인바운드 및 아웃 바운드 트래픽 규칙을 설정 하는 시간 됩니다.

1. 새 네트워크 보안 그룹을 선택 합니다.
1. 에 **개요** 표시 되는 생성 된 인바운드 및 아웃 바운드 규칙 목록이 표시 됩니다. 기본 가지 내부 Azure 액세스에 사용 되는 이미 생성 규칙입니다.

    > [!NOTE]
    > 이러한 규칙을 삭제할 수 없습니다, 하는 동안에 이러한 규칙 보다 우선적으로 적용 됩니다는 높은 우선 순위를 사용 하 여 추가 규칙을 만들 수 있습니다.

![네트워크 보안 그룹의 미리 구성된 된 인바운드 및 아웃 바운드 보안 규칙을 보여 주는 Azure portal의 스크린샷.](../media-draft/2-view-web-apps-security-group-rules.png)

1. 새 규칙을 만들려면 선택 합니다 **인바운드 보안 규칙** 네트워크 보안 그룹에 대 한 섹션입니다.
1. **추가** 단추를 클릭합니다. 여기에서 네트워크 보안 규칙에 대 한 세부 정보를 구성할 수 있습니다.

    > [!NOTE]
    > 기본적으로 규칙을 구성 하려면 고급 뷰에만 표시 됩니다 있지만 클릭 하 여 합니다 **기본** 단추 수 있도록 하려면 프로토콜을 선택 합니다.

1. 인터넷에서 HTTP 서비스에 대 한 액세스를 허용 하려고 합니다. HTTP 프로토콜을 필터링 하려면 선택 합니다 **서비스 태그** 으로 **원본** 값입니다.
1. 그런 다음 확인 합니다 **원본 서비스 태그** 로 설정 된 **인터넷**합니다.
1. 포트 범위 값 집합 `80,443` 이 서비스에 액세스 하는 데 사용 되는 포트를 나타내는입니다. (HTTP 용 포트 80은 사용 및 포트 443 HTTPS 액세스에 사용 됩니다.)
1. **프로토콜**로 **TCP**를 선택합니다.
1. 설정할 **동작** 하 **허용**합니다.
1. 규칙에 지정 된 **우선 순위** 의 값 `100`합니다.

    > [!NOTE]
    > 낮은 규칙은 수, 더 중요 합니다.

![지정된 된 구성 원본 서비스 태그 (인터넷) 및 대상 포트를 사용 하 여 인바운드 보안 규칙 추가 블레이드를 보여 주는 Azure portal의 스크린샷 범위 (80,443) 필드를 강조 표시 합니다.](../media-draft/2-add-inbound-security-rule-for-web-nsg.png)

이제 데이터베이스에 대 한 네트워크 보안 그룹 설정을 설정 하는 시간입니다. 데이터베이스에 대해는 웹 응용 프로그램 서브넷의 IP 범위에서 SQL 요청을 허용 하는 단일 수신 규칙을 설정 하 고 다른 들어오고 나가는 트래픽을 거부 합니다. 이렇게 하면 데이터베이스에 대 한 액세스를 제어 하는 요청에만 데이터베이스를 통해 시스템에 웹 사이트에서 가져오고는 다른 데이터베이스에 액세스할 수 없습니다 되었는지 확인 합니다.

1. 클릭 합니다 **리소스 만들기** 다시 만들려면 다른 **네트워킹** > **네트워크 보안 그룹** Resource Manager 배포 모델을 사용 하 합니다.

    이 시간을 만든 데이터베이스에 대 한 합니다.

1. 제공 된 **이름을** 네트워크 보안 그룹에 대 한 합니다.
1. Azure 구독, 리소스 그룹 및 원하는 위치를 선택 합니다.
1. 클릭 합니다 **만들기** 단추를 새 네트워크 보안 그룹을 만듭니다.

    ![샘플 구성 사용 하 여 네트워크 보안 그룹 블레이드 만들기를 보여 주는 Azure portal의 스크린샷.](../media-draft/2-create-database-network-security-group.png)

    네트워크 보안 그룹을 만들 때까지 대기 해야 합니다.

1. 완료 되 면 선택 합니다 **리소스로 이동** 만든 네트워크 보안 그룹 규칙을 구성 하려면 알림 영역에서 옵션입니다.

네트워크 보안 그룹에 대 한 주 포커스가 있는 웹 응용 프로그램 서브넷만의 데이터베이스 요청 수 있도록 합니다. 웹 서브넷의 IP 범위에서 들어오는 TCP 요청 포트 1433에서 설정 해야 합니다.

1. 에 **인바운드 보안 규칙** 설정을 선택 합니다 **추가** 새 규칙을 만드는 단추입니다. 이 경우에 웹 응용 프로그램 서브넷에서의 액세스를 허용 하려면.
1. 설정 하는 인바운드 규칙을 만들어야 합니다 **원본** 하 **IP 주소**.
1. 경우는 **원본 IP 주소/CIDR 범위** 는 앞서 만든 웹 서브넷의 CIDR 범위 입력 표시 합니다.
1. 에 대 한 합니다 **대상 포트 범위**, 입력 `1433` 만 Azure SQL Server 액세스를 나타냅니다.
1. 설정 된 **프로토콜** 하 **TCP** 인바운드 연결을 더욱 제한 하려면.
1. 하려는 **허용** 에 대 한 액세스 **동작**합니다.
1. 지정 된 **우선 순위** 의 `100`합니다.
1. **이름** 보안 규칙에 적절 하 게 합니다.
1. 클릭 **추가** 규칙을 추가 합니다.

![에 설명 된 구성을 사용 하 여 인바운드 보안 규칙 추가 블레이드를 보여 주는 Azure portal의 스크린샷](../media-draft/2-create-inbound-rule-for-db-security-group.png)

기본 보안 규칙은 데이터베이스 시스템에 대 한 액세스를 제한 하기 위해 적용에서 됩니다. 서브넷에 네트워크 보안 그룹을 할당 하는 것만 남아 있습니다.

1. 이전에 만든 가상 네트워크를 엽니다. 선택 된 **설정을** > **서브넷** 섹션입니다.
1. 이전에 만든 웹 서브넷을 선택 합니다.
1. 선택 된 **네트워크 보안 그룹** 웹을 위한 옵션 및 네트워크 보안 그룹을 생성 합니다.
1. 클릭 **저장할** 네트워크 보안 그룹을 서브넷에 대해 적용 됩니다.

    ![웹 서브넷에 적용 된 네트워크 보안 그룹을 보여 주는 Azure portal의 스크린샷](../media-draft/2-define-nsg-for-web-subnet.png)

데이터베이스 서브넷에 대 한 동일한 프로세스를 반복 해야 합니다.

1. 서브넷으로 다시 이동 합니다.
1. 데이터베이스 서브넷 선택
1. 설정 해당 **네트워크 보안 그룹** 데이터베이스에 대 한 네트워크 보안 그룹에 있습니다.
1. **저장**을 클릭하여 변경 내용을 저장합니다.

    ![선택한 데이터베이스 서브넷에 적용 된 네트워크 보안 그룹을 보여 주는 Azure portal의 스크린샷.](../media-draft/2-define-nsg-for-db-subnet.png)

이제 액세스를 구성한 경우 가상 네트워크 및 데이터베이스 서버 및 웹 서버에 대 한 서브넷을 적용 하는 문제입니다.

데이터베이스 서버를 사용 하 여 시작 해 보겠습니다.

1. 데이터베이스를 선택 합니다.
1. 데이터베이스에서 선택 합니다 **방화벽 및 virtual network** 구성 설정입니다.

왼쪽에 구성 하는 방법에 대 한 자세한 정보를 표시 합니다. 여기에서 다양 한 설정 해야합니다.

1. 먼저 설정 **Azure 서비스 방문 허용** 하 **OFF**합니다. 이 사용 하려는 서비스에만 설정 되어 있는지 확인 하는 것입니다.

    클라이언트 IP 주소를 보여 주는 알 수 있습니다. 클라이언트 IP 주소는 Azure SQL Server 데이터베이스에 연결할 컴퓨터의 IP 주소가입니다. 클라이언트 IP 규칙 이름 목록에 추가한 수 있습니다. SQL Server Management Studio 또는 SQL Operations Studio 서버에 연결 하려는 경우에 유용 합니다. IP 주소를 지정 하는 규칙을 연결할 수 있는 추가 됩니다. 않습니다 수 수행 하는 예제의 경우 있지만 가상 네트워크를 설정 합니다.

1. 클릭할 **기존 가상 네트워크 추가**, 새 규칙에 대 한 세부 정보를 입력 하는 옵션 화면이 표시 됩니다.

1. 입력 된 **이름을** 사용 하려는 규칙의 합니다.
1. 사용 하 고 있던 구독을 선택 합니다.
1. 가장 중요 하 게 사용 하는 가상 네트워크를 선택 합니다.
1. 데이터베이스 액세스에 대 한 적절 한 네트워크 보안 그룹 규칙을 사용 하 여 서브넷을 선택 합니다.
1. 모든 설정을 구성한 경우 선택 합니다 **사용** 단추입니다. 그런 다음 데이터베이스 가상 네트워크 내의 서브넷에 적용 됩니다.

데이터베이스 서브넷 구성 되 면 웹 서버를 사용 하 여 비슷한 단계를 수행 합니다. 하는 방법에 구성한 경우 응용 프로그램에 관계 없이 웹 응용 프로그램 웹 액세스에 대 한 서브넷을 사용 하는 몇 것입니다.

확장 집합의 단일 가상 머신 또는 가상 머신과 부하 분산 장치를 해야 하는 경우 데이터베이스에 액세스할 수 있도록 웹 서브넷 사용 하는 대로 있는지 확인 합니다. 가상 머신과 같은 리소스를 만들 때 해당 서비스의 시작 및 종료 입력 되는 정보를 제어 하는 가상 네트워크 및 서브넷 구성 되어 있는지 확인 합니다.

![가상 네트워크 및 서브넷 값을 설정한 새 가상 컴퓨터를 만드는 설정 블레이드의 단계를 보여 주는 Azure portal의 스크린샷.](../media-draft/2-configure-virtual-machine-with-subnet.png)

서브넷은 데이터베이스 및 웹 앱을 실행 중인 가상 컴퓨터 모두에 적용 되 면 다음 적절 한 구성 구성 됩니다. 앱 및 데이터베이스 간의 긴밀 한 액세스는 있습니다.

네트워크 보안은 보호의 첫 번째 핵심 요소입니다. 앱 및 데이터베이스에 연결 해야 하는 서비스 데이터베이스에 연결 수행 되었는지 하면 시스템이 더욱 안전 하 게 됩니다.
