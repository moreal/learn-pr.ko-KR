시스템에 대한 부하를 정확히 예측할 수 있는 경우는 드뭅니다. 공용 응용 프로그램이 빠르게 늘어나거나 내부 응용 프로그램이 비즈니스 성장에 따라 더 큰 사용자 기반을 지원해야 할 수도 있기 때문입니다. 부하를 예측할 수 있더라도, 균일한 수준인 경우가 거의 없습니다. 소매점에는 휴일에 더 많은 수요가 발생하고, 스포츠 웹 사이트는 플레이오프 기간에 최대 수요가 몰립니다. 여기서는 _확장/축소_ 및 _스케일 아웃/스케일 인_을 정의하고, Azure에서 크기 조정 기능을 향상하는 몇 가지 방법을 소개하고, 서버리스 및 컨테이너 기술로 아키텍처의 크기 조정 기능을 향상하는 방법을 알아봅니다.

## <a name="what-is-scaling"></a>크기 조정이란?

_크기 조정_은 응용 프로그램이 성능 요구 사항 집합을 충족하도록 돕기 위해 리소스를 관리하는 프로세스입니다.  사용자를 지원하는 리소스가 너무 많으면 효율적으로 사용하지 못하게 되고 돈을 낭비하게 됩니다. 사용 가능한 리소스가 너무 적으면 응용 프로그램의 성능에 영향을 줄 수 있습니다. 목표는 비용을 최적화하면서 정의된 성능 요구 사항을 충족하는 것입니다. 

“_리소스_”는 응용 프로그램을 실행하는 데 필요한 모든 것을 나타낼 수 있습니다. 가상 머신용 메모리 및 CPU는 가장 분명한 리소스이지만, 일부 Azure 서비스를 사용하기 위해서는 대역폭 또는 Cosmos DB 요청 단위와 같은 추상적인 측면을 고려해야 할 수 있습니다.

응용 프로그램 수요는 상수는 세계에서 필요한 리소스의 올바른 금액을 예측 쉽습니다. 실제 환경에서 응용 프로그램의 요구 적절 한 양의 리소스 해야 예측 하기 어려울 수 있도록 시간이 지남에 따라 변경 합니다. 운이 좋아서 이러한 변화가 예측 가능하거나 계절별 특성일 수 있지만 모든 응용 프로그램에서 일반적인 것은 아닙니다. 되도록 수요를 맞출 수 있는 적절한 양의 리소스를 프로비전하고, 수요의 변경에 따라 조정할 수 있습니다.

자체 서버를 구매하여 관리하는 온-프레미스 시나리오에서는 크기 조정이 어렵습니다. 리소스를 추가하게 되면 비용이 많이 들 수 있으며 온라인 상태로 전환하는 데 시간이 너무 오래 걸리는 경우도 있습니다. 때로는 늘어난 용량에 실제로 필요한 시간보다 더 오래 걸리기도 합니다. 시스템에서 수요가 낮은 시간 동안 용량을 줄이는 것도 마찬가지로 어려우므로 어쩔 수 없이 비용이 늘어날 수 있습니다.

크기 조정이 용이하다는 사실이 Azure의 핵심적인 이점입니다. 대부분의 Azure 리소스는 수요 변화에 따라 리소스를 쉽게 추가하거나 제거할 수 있도록 하며, 많은 서비스가 자동화된 옵션을 제공하므로 수요를 모니터링하고 자동으로 조정됩니다. 이러한 자동 크기 조정 기능을 사용하면 사용 가능한 인스턴스의 최소 및 최대 수준 임계값을 설정하고 성능 메트릭(예: CPU 사용률)에 따라 인스턴스를 추가 또는 제거할 수 있습니다.

> [!VIDEO https://www.microsoft.com/videoplayer/embed/RE2yBWi]

## <a name="what-is-scaling-up-or-down"></a>확장 또는 축소란?

확장은 지정된 인스턴스의 용량을 늘리는 프로세스입니다. 더 많은 처리 용량을 제공하기 위해 가상 머신을 1개의 vCPU와 3.5GB RAM에서 2개의 vCPU와 7GB RAM으로 늘릴 수 있습니다. 반면에, 축소는 지정된 인스턴스의 용량을 낮추는 프로세스입니다. 예를 들어, 가상 머신의 용량을 2개의 vCPU와 7GB RAM에서 1개의 vCPU와 3.5GB RAM으로 줄여 용량과 비용을 모두 절약할 수 있습니다. 다음 그림에는 가상 머신의 크기를 변경 하는 예가 나와 있습니다.

![수직 확장 및 성능 기능을 변경 하려면 가상 머신의 규모 축소를 보여 주는 예시입니다.](../media/2-ScaleUpDown.png)

Azure 리소스의 컨텍스트에서 확장 또는 축소의 의미를 알아보겠습니다.

- Azure Virtual Machines에서는 가상 머신 크기에 따라 크기를 조정합니다. 이 크기에는 특정 크기의 vCPU, RAM 및 로컬 저장소가 연결되어 있습니다. 예를 들어, Standard_DS1_v2 가상 머신(1개의 vCPU와 3.5GB RAM)에서 Standard_DS2_v2 가상 머신(2개의 vCPU와 7GB RAM)으로 확장할 수 있습니다.
- Azure SQL Database는 PaaS(Platform as a Service) 방식으로 구현된 Microsoft SQL Server입니다.  DTU(데이터베이스 트랜잭션 단위) 또는 vCPU 수에 따라 데이터베이스를 확장할 수 있습니다. DTU는 기본 리소스의 추상화로, CPU, IO 및 메모리가 혼합된 것입니다. 데이터베이스 인스턴스를 500개의 DTU에서 250개의 DTU로 축소할 수 있습니다.
- Azure App Service는 Azure의 PaaS 웹 사이트 호스팅 서비스입니다. 웹 사이트는 App Service 계획이라고도 하는 가상 서버 팜에서 실행됩니다. App Service 계획을 계층 간에 확장 또는 축소하고, 계층 내에 용량 옵션을 제공할 수 있습니다. 예를 들어 S1 App Service 계획에는 인스턴스당 1개의 vCPU 및 1.75GB RAM이 있습니다. 인스턴스당 2개의 vCPU와 3GB RAM을 포함하는 S2 App Service 계획으로 확장할 수 있습니다.

온-프레미스 환경에서 이러한 기능을 사용하려면 일반적으로 새 수준의 확장을 사용하기 위해 먼저 필요한 하드웨어 및 설치가 조달될 때까지 기다려야 합니다. Azure에서 물리적 리소스가 이미 배포되어 사용할 수 있습니다. 사용하려는 대체 수준의 확장만 선택해야 합니다.

선택한 클라우드 서비스에 따라 솔루션에서 확장이 미치는 영향을 고려해야 할 수 있습니다.

예를 들어 Azure SQL Database에서 확장하도록 선택한 경우에는 서비스가 개별 노드의 확장을 처리하고 서비스 작업을 계속 진행합니다. 서비스 계층 및/또는 데이터베이스의 성능 수준을 변경하게 되면 새 성능 수준에서 원본 데이터베이스의 복제본을 만든 다음, 연결을 복제본으로 전환합니다. 이 프로세스 중에는 데이터가 손실되지 않으며, 서비스가 복제본으로 전환할 때만 잠시 중단됩니다(일반적으로 4초 미만).

또는 가상 머신을 확장 또는 축소하도록 선택하는 경우 다른 인스턴스 크기를 선택하면 됩니다. 대부분의 경우 VM을 다시 시작해야 하므로, 재부팅이 필요하리라고 예상하는 것이 가장 좋으며 이 작업을 수행할 때 이러한 사실을 고려해야 합니다.

마지막으로 축소를 사용할 수 있는 경우를 항상 고려해야 합니다. 응용 프로그램에서 더 낮은 가격 계층에 적절한 성능을 제공할 수 있는 경우 Azure 청구 비용이 크게 줄어들 수 있습니다.

## <a name="what-is-scaling-out-or-in"></a>스케일 아웃 또는 스케일 인이란?

확장 및 축소는 단일 인스턴스가 포함하는 리소스 양을 사용 가능하게 조정하는 방식이지만, 스케일 아웃 및 스케일 인은 총 인스턴스 수를 조정하는 방식입니다.

_스케일 아웃_은 솔루션의 부하를 지원하기 위해 더 많은 인스턴스를 추가하는 프로세스입니다. 예를 들어 웹 사이트 프런트 엔드가 가상 머신에 호스팅된 경우, 부하 수준이 증가하면 가상 머신 수를 늘릴 수 있습니다.

_스케일 인_은 솔루션 부하를 지원하는 데 더 이상 필요하지 않은 인스턴스를 제거하는 프로세스입니다. 웹 사이트 프런트 엔드의 사용량이 낮은 경우 인스턴스 수를 줄여 비용을 절약할 수 있습니다. 다음 그림에서는 가상 컴퓨터 인스턴스 수를 변경 하는 예를 보여 줍니다.


![요청 및 리소스의 크기 조정 비용을 줄이기 위해 처리 하는 리소스 확장을 보여 주는 예시입니다.](../media/2-ScaleInOut.png)

다음은 Azure 리소스의 컨텍스트에서 스케일 아웃/스케일 인의 의미를 나타내는 몇 가지 예제입니다.

- 인프라 계층의 경우 가상 머신 확장 집합을 사용하여 인스턴스의 추가 및 제거를 자동화할 수 있습니다.
  - Virtual Machine Scale Sets를 사용하면 부하 분산된 동일한 VM 그룹을 만들고 관리할 수 있습니다.
  - VM 인스턴스의 수는 요구 또는 정의된 일정에 따라 자동으로 늘리거나 줄일 수 있습니다.
- Azure SQL Database 구현에서는 분할하여 데이터베이스 인스턴스 간에 부하를 공유할 수 있습니다. _분할_이란 동일하게 구조화된 대량의 데이터를 여러 독립적인 데이터베이스에 분산하는 기술입니다.
- Azure App Service에서 App Service 계획은 콘텐츠를 호스팅하는 가상 웹 서버 팜입니다. 이러한 방식으로 스케일 아웃하게 되면 팜의 가상 머신 수를 늘릴 수 있습니다. 가상 머신 확장 집합을 사용할 때와 마찬가지로, 인스턴스 수는 특정 메트릭 또는 일정에 따라 자동으로 늘어나거나 줄어들 수 있습니다.

스케일 아웃은 일반적으로 Azure Portal, 명령줄 도구 또는 Resource Manager 템플릿에서 간단하게 수행되며, 대부분의 경우 최종 사용자에 대해 원활하게 수행됩니다.

### <a name="autoscale"></a>자동 크기 조정

이러한 서비스 중 일부를 자동 크기 조정이라는 기능을 사용하도록 구성할 수 있습니다. 자동 크기 조정을 사용하면 더 이상 서비스 크기를 수동으로 조정할 필요가 없습니다. 대신, 인스턴스의 최소 및 최대 임계값을 설정하고, 특정 메트릭(큐 길이, CPU 사용률) 또는 일정(주중 오후 5시-오후 7시 사이)에 따라 크기를 조정할 수 있습니다. 다음 그림에서는 자동 크기 조정 기능 로드를 처리 하려면 인스턴스를 관리 하는 방법을 보여 줍니다.

![자동 크기 조정 가상 머신의 풀의 CPU 수준을 모니터링 하 고 CPU 사용률이 임계값을 초과 하는 경우 인스턴스를 추가 하는 방법을 보여 주는 예시입니다.](../media/2-autoscale.png)

### <a name="considerations-when-scaling-in-and-out"></a>스케일 인 및 스케일 아웃 시 고려 사항

스케일 아웃 시, 응용 프로그램의 시작 시간은 응용 프로그램이 스케일 아웃되는 속도에 영향을 줄 수 있습니다. 웹앱이 시작되어 사용할 수 있을 때까지 2분이 걸린다면 사용자가 각 인스턴스를 사용할 수 있을 때까지 2분이 걸립니다. 원하는 스케일 아웃 속도를 결정할 때 이러한 시작 시간을 고려할 수 있습니다.

또한 응용 프로그램이 상태를 처리하는 방법도 고려해야 합니다. 응용 프로그램이 스케일 인되면 머신에 저장된 모든 상태를 더 이상 사용할 수 없게 됩니다. 사용자가 해당 상태가 없는 인스턴스에 연결될 경우, 강제로 로그인되거나 데이터가 다시 선택되어 사용자 환경의 질이 저하될 수 있습니다. 일반적인 패턴은 Redis Cache 또는 SQL Database 등의 다른 서비스에 대해 상태를 외장화하여 웹 서버를 상태 비저장으로 만드는 것입니다. 이제 웹 프런트 엔드가 상태 비저장이므로, 어떤 개별 인스턴스가 사용 가능한지 걱정할 필요가 없습니다. 모두 동일한 작업을 수행하며 동일한 방법으로 배포됩니다.

## <a name="throttling"></a>제한

응용 프로그램의 부하가 시간에 따라 달라지게 설정했습니다. 이러한 부하는 활성 또는 동시 사용자 수와 수행 중인 활동 때문에 발생할 수 있습니다. 자동 크기 조정을 사용하여 용량을 추가할 수 있지만 제한 메커니즘을 사용하여 소스의 요청 수를 제한할 수도 있습니다. 알려진 제한을 응용 프로그램 수준에서 적용하여 성능 제한을 유지함으로써 응용 프로그램이 중단되지 않도록 할 수 있습니다. 제한 기능은 API 엔드포인트를 노출하는 응용 프로그램에서 가장 자주 사용됩니다.

응용 프로그램이 한계를 위반한 것으로 확인되면 제한 기능이 시작되고 전체 시스템 SLA가 위반되지 않도록 할 수 있습니다. 예를 들어, 고객이 데이터를 얻을 수 있도록 API를 노출한 경우 요청 수를 분당 100개로 제한할 수 있습니다. 단일 고객이 이 제한을 초과하면 다른 요청을 제출할 수 있을 때까지의 대기 시간을 포함하여 HTTP 429 상태 코드로 응답할 수 있습니다.

## <a name="serverless"></a>서버를 사용하지 않음

서버리스 컴퓨팅은 앱을 실행하는, 클라우드에 호스트된 실행 환경을 제공하지만 기본 환경을 완전히 추상화합니다. 서비스 인스턴스를 만들고 코드를 추가하기만 하면 됩니다. 인프라 관리 또는 유지 관리가 필요하지 않거나 허용되지 않습니다.

이벤트에 응답하도록 서버리스 앱을 구성합니다. 이 이벤트는 REST 엔드포인트, 타이머 또는 다른 Azure 서비스로부터 받은 메시지일 수 있습니다. 서버리스 앱은 이벤트에 의해 트리거된 경우에만 실행됩니다.

인프라는 사용자의 책임이 아닙니다. 크기 조정 및 성능이 자동으로 처리되며, 사용하는 리소스에 대해서만 요금이 청구됩니다. 용량을 예약할 필요도 없습니다. Azure Functions, Azure Container Instances 및 Logic Apps는 Azure에서 사용할 수 있는 서버리스 컴퓨팅의 예입니다.

Lamna Healthcare 예제를 다시 살펴보겠습니다. 비용 절감 및 관리 용이성을 구현할 가능성이 있습니다. API 엔드포인트를 고려하세요. 예약된 용량에 대해 비용을 지불해야 하는 Azure App Service에서 API를 호스팅하는 대신, HTTP 요청에 의해 트리거되는 Azure 함수 앱을 사용할 수 있습니다. Azure 함수를 사용하면 팀에서 각 트랜잭션을 처리하는 데 필요한 리소스에 대해서만 비용을 지불할 수 있습니다. 비용 및 크기 조정은 시스템의 트랜잭션 수와 직접적으로 관련이 있습니다.

## <a name="containers"></a>컨테이너

컨테이너는 가상화된 환경에서 응용 프로그램을 실행하는 방법입니다. 가상 머신은 하이퍼바이저가 단일 물리적 서버에서 가상화된 여러 운영 체제를 실행할 수 있도록 하드웨어 수준에서 가상화됩니다. 컨테이너는 가상화를 한 수준 올려줍니다. OS 수준에서 가상화가 수행되어 동일한 OS 내에서 동일한 응용 프로그램 인스턴스를 여러 개 실행할 수 있습니다.

컨테이너는 스케일 아웃 시나리오에 적합합니다. 또한 컨테이너는 기본적으로 경량이며, 환경 및 수요의 변화에 따라 동적으로 생성, 확장 및 중지되도록 설계되었습니다.

컨테이너를 사용할 경우 각 가상 머신에서 여러 개의 격리된 응용 프로그램을 실행할 수 있다는 혜택이 있습니다. 컨테이너 자체가 커널 수준에서 보안이 유지되고 격리되므로 워크로드마다 별도의 VM을 만들지 않아도 됩니다.

가상 머신에서 컨테이너를 실행할 수 있지만 컨테이너의 관리 용이성 및 크기 조정에 중점을 두는 몇 가지 Azure 서비스가 있습니다.

- **AKS(Azure Kubernetes Service)**

  Azure Container Service를 사용하면 가상 머신이 노드로 작동하도록 설정할 수 있습니다. Azure는 Kubernetes 관리 평면을 호스트하고, 컨테이너를 호스트하는 실행 중인 작업자 노드에 대해서만 요금을 청구합니다.

  Azure의 작업자 노드 수를 늘리려면 Azure CLI를 사용하여 수동으로 늘릴 수 있습니다. 쓰기 시, 작업자 노드의 자동 크기 조정을 사용 가능하게 하는 AKS의 클러스터 자동 크기 조정기가 미리 보기로 제공됩니다. Kubernetes 클러스터에서는 Horizontal Pod Autoscaler를 사용하여 배포할 컨테이너의 인스턴스 수를 스케일 아웃할 수 있습니다.

  또한 AKS는 아래에 설명된 Virtual Kubelet으로도 크기를 조정할 수 있습니다.

- **ACI(Azure Container Instances)**
  
  Azure Container Instances는 주문 시 컨테이너를 만들고 실행하는 서버리스 접근 방식입니다. 초당 실행 시간에 대해서만 요금이 청구됩니다.

  Virtual Kubelet을 사용하여 Azure Container Instances를 AKS를 포함하는 Kubernetes 환경에 연결할 수 있습니다. Virtual Kubelet을 사용하면 Kubernetes 클러스터에 추가 컨테이너 인스턴스가 필요한 경우 ACI에서 이러한 수요를 충족시킬 수 있습니다. ACI는 서버리스이므로 예약된 용량을 유지할 필요가 없습니다. 따라서 서버리스의 초당 요금으로 Kubernetes 크기 조정의 제어 능력 및 유연성을 활용할 수 있습니다. 쓰기 시, Virtual Kubelet은 실험적 소프트웨어로 설명되며, 프로덕션 시나리오에서는 사용하면 안 됩니다.

## <a name="scaling-at-lamna-healthcare"></a>Lamna Healthcare에서 크기 조정

Lamna Healthcare는 환자 관리 및 예약 시스템을 운영합니다. 관리 시스템은 수십 개의 병원 및 의료 시설에서 진료 예약 및 환자 기록을 처리합니다. 로컬 의료 서비스는 최대치로 운영되고 있으며 현재로서는 성장의 조짐이 보이지 않고 있습니다. 이 시스템은 Azure App Service에 호스팅된 PHP 웹 사이트에서 실행되고 있습니다.

주로 월요일부터 금요일, 9시부터 5시까지 운영되므로 응용 프로그램의 부하 패턴은 예측 가능합니다.  화요일부터 금요일까지 전체 시스템에서 시간당 평균 1,200개의 트랜잭션이 처리됩니다. 주말 동안에는 시간당 500개의 트랜잭션을 처리합니다. 평온하게 주말이 지나간 후에 월요일은 시간당 평균 2,000개 트랜잭션을 처리하느라 분주합니다.

응용 프로그램은 S1 App Service 계획에 호스팅되지만, 운영 팀은 모든 인스턴스에서 CPU 사용률이 높게 유지된다는 사실을 알았습니다(95% 초과). 사용률이 높으면 응용 프로그램의 처리 및 로드 시간에 영향을 줍니다. 클라우드 환경에서는 활용률이 높은 리소스가 꼭 나쁜 것만은 아닙니다. 배포된 리소스가 잘 사용되고 있으므로 비용 가치를 뽑아내고 있다는 것을 의미합니다. 

팀은 배포된 인스턴스의 App Service 계획 수준을 S1(1개 vCPU와 1.75GB RAM)에서 S2(2개 vCPU와 3GB RAM)로 _확장_하기로 결정합니다. Azure Portal을 사용하여 이 작업을 쉽게 수행할 수 있지만 Azure CLI, Azure PowerShell에서 단일 명령을 사용하거나 Resource Manager 템플릿을 사용하여 같은 작업을 수행할 수도 있습니다.

부하 프로필이 예측 가능하기 때문에, 팀은 일정에 따라 배포된 인스턴스 수를 자동화하기로 합니다. App Service 계획의 자동 크기 조정 일정을 구성합니다. 두 개의 인스턴스가 시간당 500개의 트랜잭션을 충분히 처리한다고 가정하겠습니다. 팀은 부하 테스트를 통해 얻은 인사이트 및 모니터링 결과에 따라 요구 사항을 충족하기 위해 화요일에서 금요일까지는 6개 인스턴스로, 월요일에는 8개 인스턴스로 크기를 조정할 수 있습니다.

또한 자동 크기 조정은 예측할 수 없는 시나리오를 대비할 수 있는 추가적인 혜택도 제공합니다. 이 사이트의 부하는 주말에 갑자기 예상된 것보다 훨씬 더 높아졌습니다(감기 및 독감 때문에 겨울에 예약이 더 많음). 팀은 CPU 비율이 90%를 초과할 때 인스턴스를 하나씩 늘리고, 사용량이 15%보다 낮아질 때 인스턴스를 하나씩 줄여 자동으로 크기를 조정하도록 설정할 수 있습니다.

팀은 Azure API Management 인스턴스를 기준으로 하는 환자 예약 API 내에서 제한 패턴을 사용했습니다. 이 패턴은 시스템에서 특정 크기의 처리량만 허용하여 시스템 성능이 저하되지 않도록 방지하는 데 도움이 됩니다.

## <a name="summary"></a>요약

확대 및 축소와 스케일 인 및 스케일 아웃에 대해 알아보았으며, 아키텍처에서 이러한 옵션을 활용하는 방법을 살펴보았습니다. 또한 서버리스 기술과 컨테이너로 크기 조정 기능을 어떻게 발전시킬 수 있는지도 살펴보았습니다. 다음에는 네트워크 성능이 응용 프로그램에 영향을 미치는 방식과 네트워크를 최적화할 수 있는 다양한 방법을 살펴보겠습니다.