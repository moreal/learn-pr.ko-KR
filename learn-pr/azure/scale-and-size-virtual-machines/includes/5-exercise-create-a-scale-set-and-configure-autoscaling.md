이 연습에서는 Azure Portal을 사용하여 자동 크기 조정 규칙이 포함된 가상 머신 확장 집합을 만듭니다.

## <a name="create-a-virtual-machine-scale-set"></a>가상 머신 확장 집합 만들기

1. [Azure Portal](https://portal.azure.com/learn.docs.microsoft.com?azure-portal=true)에서 **리소스 만들기**를 클릭합니다.

1. 검색 상자에서 **확장 집합**을 입력하고 <kbd>ENTER</kbd> 키를 누릅니다. **결과** 블레이드에서 **가상 머신 확장 집합**을 클릭하고, **가상 머신 확장 집합** 블레이드에서 **만들기**를 클릭합니다.

1. **가상 머신 확장 집합 만들기** 블레이드에서 다음 값을 입력합니다.
    - **이름**에 _WebServerSS_를 사용합니다.
    - **운영 체제 디스크 이미지**에 대해 _Windows Server 2016 Datacenter_를 유지합니다.
    - **구독**에 대해 _컨시어지 구독_을 사용합니다.
    - **리소스 그룹**에 대해 **<rgn>[샌드박스 리소스 그룹 이름]</rgn>** 을 선택합니다.
    - [!include[](../../../includes/azure-sandbox-regions-note-friendly.md)] 목록의 위치를 선택합니다.

    - 유효한 **사용자 이름** 및 **암호**를 설정합니다. (나중에 사용할 수 있게 적어둡니다)
    - **인스턴스 수**를 _2_로 설정합니다.
    - **인스턴스 크기**를 _D2s_v3_로 설정합니다.
    - **자동 크기 조정**을 _사용하지 않음_으로 유지합니다.
    - **부하 분산 장치**를 선택합니다.
    - **공용 IP 주소 이름**에 _WebServerPubIP_를 입력합니다.
    - **도메인 이름 레이블**이 고유하도록 이니셜 + 날짜 + 시간을 사용합니다.
    - **가상 네트워크**에 대해 **새로 만들기**를 선택합니다. 가상 네트워크의 이름을 **SSVNet**으로 지정하고 **만들기**를 클릭하여 VNet을 만듭니다.

1. **만들기**를 클릭하여 확장 집합을 배포합니다.

1. 확장 집합이 만들어질 때까지 기다립니다.

## <a name="create-and-apply-autoscale-rules"></a>자동 크기 조정 규칙 만들기 및 적용

1. 왼쪽 사이드바에서 **리소스 그룹**을 클릭합니다.

1. 리소스 그룹 **<rgn>[샌드박스 리소스 그룹 이름]</rgn>** 을 선택합니다.

1. **<rgn>[샌드박스 리소스 그룹 이름]</rgn>** 블레이드에서 **WebServerSS** 개체를 클릭하여 확장 집합 엽니다.

1. **WebServerSS** 블레이드의 **설정**에서 **인스턴스**를 클릭합니다. 확장 집합 내에서 실행되는 두 개의 가상 머신 인스턴스에 유의하세요.

1. **WebServerSS** 블레이드에서 **크기 조정**을 클릭합니다.

1. **WebServerSS - 크기 조정** 블레이드에서 **자동 크기 조정 사용**을 클릭합니다.

1. 구성 화면에서 이름을 **WebAutoscaleSetting**으로 설정합니다.

1. 기본 조건에서 **인스턴스 제한**을 찾아 다음 값을 설정합니다.

    |설정|값|
    |---|---|
    |최소|2|
    |최대|8|
    |기본값|2|

1. **규칙 추가**를 클릭합니다.

1. **크기 조정 규칙** 블레이드에서 다음 정보를 입력하여 평균 CPU 사용량이 5분 동안 75%를 초과하면 두 개의 가상 머신을 추가로 스케일 아웃하는 규칙을 만든 다음, **추가**를 클릭합니다.

    |설정|값|
    |---|---|
    |시간 집계|평균|
    |메트릭 이름|CPU 사용률|
    |시간 조직 통계|평균|
    |연산자|보다 큼|
    |임계값|75|
    |기간(분)|5|
    |작업|다음을 기준으로 개수 늘이기|
    |인스턴트 수|2|
    |정지 시간(분)|5|

1. 이번에는 다른 규칙을 추가하고 다음 정보를 입력하여 평균 CPU 사용량이 5분 동안 30% 미만이면 한 번에 하나의 서버를 스케일 인하는 규칙을 만든 다음, **추가**를 클릭합니다.

    |설정|값|
    |---|---|
    |시간 집계|평균|
    |메트릭 이름|CPU 사용률|
    |시간 조직 통계|평균|
    |연산자|보다 작음|
    |임계값|30|
    |기간(분)|5|
    |작업|다음을 기준으로 개수 줄이기|
    |인스턴트 수|1|
    |정지 시간(분)|5|

1. 규칙은 다음과 같이 표시되어야 합니다.

    ![VM 확장 집합에 적용된 자동 크기 조정 규칙 집합의 스크린샷](../media/5-scale-rules.png)

1. **저장**을 클릭합니다.

## <a name="generate-load-to-demonstrate-autoscaling"></a>로드를 생성하여 자동 크기 조정 시연

이제 SysInternals **CPUStress.exe** 도구를 사용하여 확장 집합의 가상 머신에서 로드를 생성하고 자동 스케일 아웃을 시연합니다.

해당 VM에서 이 도구를 실행하므로 이를 위한 Windows는 필요가 없습니다. 그러나 원격 데스크톱 클라이언트는 _반드시_ 필요합니다. Microsoft에는 macOS 및 Windows용 클라이언트가 있으며, 다양한 Linux 분산에도 클라이언트가 포함됩니다.

1. 연결할 공용 IP 주소를 확인하려면 리소스 그룹 **<rgn>[샌드박스 리소스 그룹 이름]</rgn>** 으로 이동합니다. **<rgn>[샌드박스 리소스 그룹 이름]</rgn>** 블레이드에서 **WebServerSSlb** 개체를 클릭합니다.

1. **WebServerSSlb** 블레이드에서 **프런트 엔드 IP 구성**을 클릭하고 표시된 공용 IP 주소를 적어 둡니다. **LoadBalancerFrontEnd** 블레이드를 닫습니다.

1. 연결할 포트 번호를 확인하려면 **WebServerSSlb** 블레이드에서 **인바운드 NAT 규칙**을 클릭합니다. 각 가상 머신에 대한 [서비스] 열의 사용자 지정 포트 번호를 적어 둡니다.

1. 로컬 컴퓨터에서 **원격 데스크톱 연결**을 시작합니다. **컴퓨터** 상자에서 부하 분산 장치의 공용 IP 주소, 콜론 및 인스턴스 0에 대한 포트 번호 값을 차례로 입력한 다음(예: 40.67.191.221:50000), **연결**을 클릭합니다.

1. **Windows 보안** 대화 상자에서 **추가 선택**을 클릭한 다음, **다른 계정 사용**을 클릭합니다. **사용자 이름** 및 **암호** 상자에 확장 집합을 만들 때 위에서 지정한 자격 증명을 입력합니다.

1. **원격 데스크톱 연결** 대화 상자에서 **예**를 클릭합니다.

1. 가상 머신 원격 데스크톱에서 Internet Explorer를 열고, **Internet Explorer 설정** 대화 상자에서 **확인**을 클릭합니다.

1. **Internet Explorer**의 주소 표시줄에서 **http://download.sysinternals.com/files/CPUSTRES.zip**을 입력하고 <kbd>ENTER</kbd> 키를 누릅니다. **Internet Explorer** 대화 상자에서 **추가**를 클릭합니다. **신뢰할 수 있는 사이트** 대화 상자에서 **추가**를 클릭한 다음, **닫기**를 클릭합니다.

1. 다운로드 프롬프트가 자동으로 표시되지 않으면 URL을 다시 입력하고 <kbd>ENTER</kbd> 키를 눌러야 할 수도 있습니다. **Internet Explorer** 대화 상자에서 **저장**을 클릭합니다. 다운로드가 완료되면 **폴더 열기**를 클릭합니다.

1. **다운로드** 폴더에서 **CPUSTRES**를 두 번 클릭한 다음, **CPUSTRES** 응용 프로그램을 두 번 클릭합니다. **압축(ZIP) 폴더** 대화 상자에서 **실행**을 클릭합니다.

1. **CPU 스트레스** 창에 있는 **스레드 1** 아래의 **활동** 드롭다운에서 **최대**를 선택합니다. **스레드 2** 아래에서 **활동** 확인란을 클릭하고, **활동** 드롭다운에서 드롭다운 내의 아래로 화살표를 클릭하고 **최대**를 선택합니다. 이러한 설정은 즉시 적용됩니다.

1. Windows 시작 단추를 클릭한 다음, **작업 관리자**를 클릭합니다. 작업 관리자에서 **자세한 내용**을 클릭하고, CPU가 75%를 초과하는지 확인합니다.

1. 확장 집합의 다른 가상 머신에서 **CPUSTRES**의 설치 및 시작을 **반복**한 다음, 5분 동안 기다립니다.

1. Azure Portal에서 리소스 그룹 **<rgn>[샌드박스 리소스 그룹 이름]</rgn>** 으로 이동합니다. **<rgn>[샌드박스 리소스 그룹 이름]</rgn>** 블레이드에서 **WebServerSS** 개체를 클릭합니다. **WebServerSS** 블레이드에서 **인스턴스**를 클릭합니다. 확장 집합 내에 표시되는 가상 머신 인스턴스의 수와 상태를 확인합니다.

여기서는 두 개의 가상 머신이 포함된 가상 머신 확장 집합을 만들었습니다. 그런 다음, 확장 집합을 자동으로 스케일 아웃 및 스케일 인하는 규칙을 만들고, 해당 규칙을 자동 크기 조정 프로필에 추가했습니다.
